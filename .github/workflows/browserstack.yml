name: Cypress parallel tests

on: 
  push:
    branches:
      - local
  
jobs:
  browserStack_job:
    name: 'BrowserStack setup on Ubuntu'
    runs-on: ubuntu-latest  # Can be self-hosted runner also
    steps:
    - name: 'BrowserStack Env Setup'  # Invokes the setup-env action
      uses: browserstack/github-actions/setup-env@master
      with:
        username:  ${{ secrets.BROWSERSTACK_USERNAME }}
        access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
    - name: 'BrowserStack Local Tunnel Setup'  # Invokes the setup-local action
      uses: browserstack/github-actions/setup-local@master
      with:
        local-testing: start
        local-identifier: random
        local-logging-level: all-logs
        local-args: --parallel-runs 2

  install_job:
    name: Install NPM
    runs-on: ubuntu-latest
    needs: browserStack_job
    steps:
      - uses: actions/checkout@v3
      # install a specific version of Node using
      # https://github.com/actions/setup-node
      - name: Use Node.js v16
        uses: actions/setup-node@v3
        with:
          node-version: 16
  cypress_job:
    name: Cypress job
    runs-on: ubuntu-latest
    #container: cypress/browsers:node16.17.1-chrome105-ff104-edge
    needs: install_job
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Run Cypress E2E Tests
      uses: cypress-io/github-action@v4
      with:
        start: npm start
        wait-on: 'http://localhost:8080'
        wait-on-timeout: 60
        #install-command: yarn --frozen-lockfile --silent
        spec: cypress/e2e/2-advanced-examples/*.cy.js
  stop_job:
    name: 'BrowserStackLocal Stop'  # Terminating the BrowserStackLocal tunnel connection
    needs: cypress_job
    steps:
    - name: val bored
      uses: browserstack/github-actions/setup-env@master
      with:
        username:  ${{ secrets.BROWSERSTACK_USERNAME }}
        access-key: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}

      uses: browserstack/github-actions/setup-local@master
      with:
        local-testing: stop

      uses: actions/upload-artifact@master
      with:
        name: screenshots
        path: cypress/screenshots
        if: failure()
    # video should always be generated
      uses: actions/upload-artifact@master
      with:
        name: videos
        path: cypress/videos